# CPU 环境测试指南

## 📋 概述

本指南帮助您在 CPU 环境下测试水印去除服务。CPU 环境下的性能会比 GPU 环境慢，但仍可正常工作。

## 🔧 已优化的 CPU 设置

### 自动优化功能
- ✅ 自动检测 CPU 环境并调整模型参数
- ✅ 使用 `float32` 精度（CPU 友好）
- ✅ 减少束搜索复杂度（`num_beams=1`）
- ✅ 限制最大生成长度（`max_new_tokens=512`）
- ✅ 启用 CPU 优化（MKL、MKLDNN）
- ✅ 设置合理的线程数（4线程）

### 已解决的警告
- ✅ 修复 FastAPI `on_event` 弃用警告（使用 `lifespan`）
- ✅ 优化 CPU 环境下的模型加载
- ✅ 添加 LaMa 加载失败的备用方案

## 🚀 快速测试

### 1. 启动服务
```bash
# 在一个终端窗口中启动服务
python main.py
```

等待看到以下信息：
```
✅ 模型加载完成，服务已就绪
INFO:     Application startup complete.
```

### 2. 运行测试脚本
在另一个终端窗口中：

```bash
# 健康检查
python quick_test.py --health

# 快速测试
python quick_test.py --quick

# 完整测试
python quick_test.py
```

## ⏱️ 性能预期

### CPU 环境性能基准
- **首次启动**: 2-5 分钟（下载模型）
- **水印检测**: 10-30 秒/图片
- **LaMa 修复**: 30-120 秒/图片
- **透明化处理**: 5-15 秒/图片

> 💡 **提示**: 性能取决于 CPU 性能和图片大小

## 🐛 常见问题解决

### 1. 服务启动缓慢
**现象**: 长时间停留在模型下载阶段
```
A new version of the following files was downloaded from https://huggingface.co/microsoft/Florence-2-large:
```

**解决方案**:
- ✅ 正常现象，首次需要下载模型（~2GB）
- ✅ 请耐心等待，后续启动会快很多
- ✅ 确保网络连接稳定

### 2. LaMa 模型加载失败
**现象**: 
```
❌ LaMa 模型加载失败
⚠️ 将使用 OpenCV 修复作为备用方案
```

**解决方案**:
- ✅ 已自动启用 OpenCV 备用方案
- ✅ 功能仍可正常使用，只是效果略差
- ✅ 如需完整 LaMa 功能，请确保安装了所有依赖

### 3. 内存不足
**现象**: 
```
RuntimeError: [Errno 12] Cannot allocate memory
```

**解决方案**:
```bash
# 限制 PyTorch 线程数
export OMP_NUM_THREADS=2
export MKL_NUM_THREADS=2

# 重启服务
python main.py
```

### 4. 处理速度过慢
**优化建议**:
1. 使用小尺寸图片测试（<800x600）
2. 调整边界框阈值：`max_bbox_percent=15.0`
3. 优先使用透明化方法（更快）

## 📊 测试结果示例

### 正常输出示例
```
2025-07-16 16:01:10.255 | INFO | 正在启动水印去除服务...
2025-07-16 16:01:15.123 | INFO | 使用设备: cpu
2025-07-16 16:01:15.124 | INFO | 加载 Florence-2 模型到 cpu...
2025-07-16 16:01:45.567 | INFO | Florence-2 模型加载成功
2025-07-16 16:01:45.568 | INFO | 加载 LaMa 模型到 cpu...
2025-07-16 16:02:15.890 | INFO | LaMa 模型加载成功
2025-07-16 16:02:15.891 | INFO | 模型加载完成，服务已就绪
```

### 测试脚本输出
```
🚀 开始水印去除服务综合测试
============================================================
📷 创建测试图片: test_watermark.jpg
✅ API 服务健康检查通过
🔍 测试水印检测功能...
✅ 水印检测成功 (耗时: 15.23秒)
🛠️ 测试水印去除功能 (方法: lama)...
✅ 水印去除成功 (耗时: 45.67秒)
🛠️ 测试水印去除功能 (方法: transparent)...
✅ 水印去除成功 (耗时: 8.91秒)
============================================================
🎉 所有测试通过! (3/3)
✅ 服务运行正常，可以开始使用
```

## 🎯 使用建议

### 开发环境
- 使用快速测试验证基本功能
- 小图片测试（400x300）
- 优先使用透明化方法

### 生产环境
- 建议使用 GPU 环境
- 如必须使用 CPU，考虑多实例负载均衡
- 设置合理的超时时间

## 📞 获取帮助

如果遇到问题：
1. 检查日志输出
2. 运行 `python quick_test.py --health` 验证服务状态
3. 查看 [故障排除文档](README_DEPLOY.md#故障排除)

---

💡 **小贴士**: CPU 环境主要用于功能验证和轻量使用，生产环境建议使用 GPU 以获得最佳性能。 